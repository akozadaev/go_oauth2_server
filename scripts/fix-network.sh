#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ Go –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

set -e

echo "üåê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é –¥–ª—è Go –º–æ–¥—É–ª–µ–π..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É..."
if ping -c 1 8.8.8.8 > /dev/null 2>&1; then
    echo "‚úÖ IPv4 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å IPv4 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º IPv6
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ IPv6..."
if ping6 -c 1 2001:4860:4860::8888 > /dev/null 2>&1; then
    echo "‚úÖ IPv6 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ö†Ô∏è  IPv6 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—Ç–∫–ª—é—á–∞–µ–º –µ–≥–æ –¥–ª—è Go"
    export GODEBUG=netdns=go
fi

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Go proxy
echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Go proxy..."
export GOPROXY=https://proxy.golang.org,direct
export GOSUMDB=sum.golang.org
export GONOPROXY=""
export GONOSUMDB=""
export GOPRIVATE=""

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º
echo "üîÑ –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–∫—Å–∏..."

# –ü—Ä–æ–±—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–∫—Å–∏
if go env GOPROXY | grep -q "proxy.golang.org"; then
    echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Go proxy"
else
    echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Go proxy"
    go env -w GOPROXY=https://proxy.golang.org,direct
fi

# –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –º–æ–¥—É–ª–µ–π
echo "üßπ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –º–æ–¥—É–ª–µ–π..."
if [ -w "$(go env GOMODCACHE)" ] 2>/dev/null; then
    go clean -modcache
    echo "‚úÖ –ö–µ—à –º–æ–¥—É–ª–µ–π –æ—á–∏—â–µ–Ω"
else
    echo "‚ö†Ô∏è  –ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º..."
    # –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
    rm -rf ./vendor/ 2>/dev/null || true
fi

# –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
echo "‚¨áÔ∏è  –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º..."
timeout 300 go mod download 2>/dev/null || {
    echo "‚ö†Ô∏è  –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã..."

    # –ü—Ä–æ–±—É–µ–º –∫–∏—Ç–∞–π—Å–∫–∏–π –ø—Ä–æ–∫—Å–∏
    echo "üá®üá≥ –ü—Ä–æ–±—É–µ–º –∫–∏—Ç–∞–π—Å–∫–∏–π Go proxy..."
    export GOPROXY=https://goproxy.cn,direct
    go env -w GOPROXY=https://goproxy.cn,direct
    timeout 300 go mod download 2>/dev/null || {

        # –ü—Ä–æ–±—É–µ–º –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–π –ø—Ä–æ–∫—Å–∏
        echo "üá™üá∫ –ü—Ä–æ–±—É–µ–º –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–π Go proxy..."
        export GOPROXY=https://goproxy.io,direct
        go env -w GOPROXY=https://goproxy.io,direct
        timeout 300 go mod download 2>/dev/null || {

            echo "‚ùå –í—Å–µ –ø—Ä–æ–∫—Å–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –ø—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ..."
            export GOPROXY=direct
            go env -w GOPROXY=direct
            timeout 600 go mod download 2>/dev/null || {
                echo "‚ùå –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ç–æ–∂–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
                echo "üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å sudo –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å vendor –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é"
                exit 1
            }
        }
    }
}

echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
go mod verify || echo "‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã"

echo "‚úÖ –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!"
